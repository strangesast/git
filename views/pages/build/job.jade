extends ../nav_workspace

block workspace
  h1=job.name
  span=job._id
  p=job.description

  div
    h1 Tree
    if tree.length
      each branch in tree
        div(level=branch.level)
          span #{branch.level} #{branch.type} #{included[branch['type'] + 's'][branch['_id']].name}
    else
      p Tree empty.

  div
    h1 Components
    h2 Phases
    if phases.length
      each phase in phases
        div(id=phase._id)
          h3=phase.name
          p Parent: #{phase.parent ? phase.parent.name : 'null'}
          span Description:
          if phase.description
            p=phase.description
          else
            p
              i (no description)
    else
      p No phases

    if user && user._id.equals(job.owner)
      form(name='new-phase', method='post', action='/api/jobs/#{job._id}/phases')
        label(for='new-phase-name-input') Name
        br
        input#new-phase-name-input(name='name', type='text')
        br
        label(for='new-phase-parent-input') Parent
        br
        select#new-phase-parent-input(name='parent', type='text')
          option(value='') null
          each phase in phases
            option(value=phase._id)=phase.name
        br
        label(for='new-phase-description-textarea') Description
        br
        textarea(name='description')
        br
        button(type='submit') Submit

  div
    h2 Buildings
    if buildings.length
      each building in buildings
        div(id=building._id)
          h3=building.name
          p Parent: #{building.parent ? building.parent.name : 'null'}
          span Description:
          if building.description
            p=building.description
          else
            p
              i (no description)
    else
      p No buildings

    if user && user._id.equals(job.owner)
      form(name='new-building', method='post', action='/api/jobs/#{job._id}/buildings')
        label(for='new-building-name-input') Name
        br
        input#new-building-name-input(name='name', type='text')
        br
        label(for='new-building-parent-input') Parent
        br
        select#new-building-parent-input(name='parent', type='text')
          option(value='') null
          each building in buildings
            option(value=building._id)=building.name
        br
        label(for='new-building-description-textarea') Description
        br
        textarea(name='description')
        br
        button(type='submit') Submit


  div
    h2 Components
    if components.length
      each component in components
        div(id=component._id)
          h3=component.name
          p Parent: #{component.parent ? component.parent.name : 'null'}
          p Phase: #{component.phase ? component.phase.name : 'null'}
          p Building: #{component.building ? component.building.name : 'null'}

          span Description:
          if component.description
            p=component.description
          else
            p
              i (no description)
          p Parts
          table(id='#{component._id}-parts')
            tr
              th Core Part
              th Name
              th Description
              th Qty
              th Price

            if component.parts.length
              each part in component.parts
                tr
                  td=((part.part in parts) ? parts[part.part].description : part.part)
                  td=part.name
                  td=part.description
                  td=part.qty
                  td=part.price
            else
              tr
                td No parts

          p Add part
          form(action='/api/components/#{component._id}/parts', method='post')
            label Part List
              input(name='part', list='part-catalog-list')
            button(type='submit') Submit

    else
      p No Components

    datalist#part-catalog-list
      -for(var part in parts)
        option(value=part)=parts[part].description

    if user && user._id.equals(job.owner)
      form(name='new-component', method='post', action='/api/jobs/#{job._id}/components')
        label(for='new-component-name-input') Name
        br
        input#new-component-name-input(name='name', type='text')
        br
        label(for='new-component-phase-input') Phase
        br
        select#new-component-phase-input(name='phase', type='text')
          option(value='') null
          each phase in phases
            option(value=phase._id)=phase.name
        br
        label(for='new-component-building-input') Building
        br
        select#new-component-building-input(name='building', type='text')
          option(value='') null
          each building in buildings
            option(value=building._id)=building.name
        br

        label(for='new-component-parent-input') Parent
        br
        select#new-component-parent-input(name='parent', type='text')
          option(value='') null
          each component in components
            option(value=component._id)=component.name
        br
        label(for='new-component-description-textarea') Description
        br
        textarea(name='description')
        br
        button(type='submit') Submit
